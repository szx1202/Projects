<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Controllo Irrigatore on demand (1 Pompa)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #f0f2f5; color: #1c1e21; margin: 0; padding: 20px; display: flex; justify-content: center; }
        .container { max-width: 600px; width: 100%; }
        h1, h2 { color: #0056b3; border-bottom: 2px solid #ddd; padding-bottom: 10px; }
        .card { background-color: #fff; border-radius: 8px; padding: 20px; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .data-item { display: flex; justify-content: space-between; align-items: center; padding: 8px 0; font-size: 1.1em; }
        .data-label { font-weight: bold; }
        .data-value { font-family: "Courier New", Courier, monospace; background-color: #e9ecef; padding: 5px 10px; border-radius: 5px; color: #000; }
        .button { display: block; width: 100%; padding: 12px; font-size: 1.1em; font-weight: bold; color: #fff; border: none; border-radius: 5px; cursor: pointer; margin-top: 15px; transition: background-color 0.3s, opacity 0.3s; }
        .button:disabled { cursor: not-allowed; opacity: 0.6; }
        .btn-on { background-color: #dc3545; }
        .btn-on:hover:not(:disabled) { background-color: #c82333; }
        .btn-off { background-color: #28a745; }
        .btn-off:hover:not(:disabled) { background-color: #218838; }
        .btn-action { background-color: #007bff; }
        .btn-action:hover:not(:disabled) { background-color: #0069d9; }
        #connection-status { text-align: center; padding: 10px; border-radius: 5px; margin-bottom: 20px; font-weight: bold; }
        .status-connected { background-color: #d4edda; color: #155724; }
        .status-disconnected { background-color: #f8d7da; color: #721c24; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Dashboard Irrigatore On Demand</h1>
        <div id="connection-status">Connessione in corso...</div>

        <div class="card">
            <h2><span role="img" aria-label="thermometer">üå°Ô∏è</span> Dati Ambientali</h2>
            <div class="data-item">
                <span class="data-label">Temperatura Aria:</span>
                <span id="temp-aria" class="data-value">--.- ¬∞C</span>
            </div>
            <div class="data-item">
                <span class="data-label">Umidit√† Aria:</span>
                <span id="umidita-aria" class="data-value">--.- %</span>
            </div>
        </div>

        <div class="card">
            <h2><span role="img" aria-label="water-drop">üíß</span> Pompa</h2>
            <div class="data-item">
                <span class="data-label">Umidit√† Terreno:</span>
                <span id="umidita-terreno" class="data-value">--.- %</span>
            </div>
            <div class="data-item">
                <span class="data-label">Stato Pompa:</span>
                <span id="stato-pompa" class="data-value">Sconosciuto</span>
            </div>
            <button id="btn-pompa" class="button" disabled>Attendi stato...</button>
        </div>

        <div class="card">
            <h2><span role="img" aria-label="refresh">üîÑ</span> Azioni</h2>
            <button id="btn-refresh" class="button btn-action" disabled>Aggiorna Dati</button>
        </div>
    </div>

<script>
    console.log("--- Script Iniziato ---");

    const mqttBrokerHost = "192.168.1.103";
    const mqttBrokerPort = 9001;
    const topicPrefix = "irrigator1psod"; // VERIFICA CHE SIA CORRETTO
    console.log("Topic Prefix impostato su:", topicPrefix);

    const topics = {
        tempAria:       `${topicPrefix}/sensor/temperatura_aria/state`,
        umiditaAria:    `${topicPrefix}/sensor/umidita_aria/state`,
        umiditaTerreno: `${topicPrefix}/sensor/umidita_terreno/state`,
        statoPompa:     `${topicPrefix}/switch/pompa/state`,
        cmdPompa:       `${topicPrefix}/switch/pompa/command`,
        cmdDataRequest: `${topicPrefix}/data/request/command`
    };

    const elements = {
        connectionStatus: document.getElementById('connection-status'),
        tempAria:         document.getElementById('temp-aria'),
        umiditaAria:      document.getElementById('umidita-aria'),
        umiditaTerreno:   document.getElementById('umidita-terreno'),
        statoPompa:       document.getElementById('stato-pompa'),
        btnPompa:         document.getElementById('btn-pompa'),
        btnRefresh:       document.getElementById('btn-refresh')
    };

    const clientId = "mqtt_dashboard_" + Math.random().toString(16).substr(2, 8);
    console.log("Creo client MQTT con ID:", clientId);
    const client = new Paho.MQTT.Client(mqttBrokerHost, mqttBrokerPort, clientId);

    client.onConnectionLost = onConnectionLost;
    client.onMessageArrived = onMessageArrived;

    console.log("Tento la connessione al broker...");
    client.connect({
        onSuccess: onConnect,
        onFailure: onFailure,
    });

    function onConnect() {
        console.log("SUCCESSO: Connesso al broker MQTT!");
        updateConnectionStatus(true);
        
        console.log("--- Inizio Sottoscrizione ai Topic di Stato ---");
        Object.values(topics).forEach(topic => {
            if (topic.endsWith('/state')) {
                client.subscribe(topic, {
                    onSuccess: () => console.log("SUCCESSO: Sottoscritto a:", topic),
                    onFailure: (err) => console.error("FALLIMENTO: Sottoscrizione a", topic, "fallita:", err)
                });
            }
        });
        console.log("--- Fine Sottoscrizione ---");

        elements.btnRefresh.disabled = false;
        console.log("Bottone Refresh Abilitato.");
    }

    function onFailure(response) {
        console.error("FALLIMENTO CONNESSIONE:", response.errorMessage);
        updateConnectionStatus(false, "Connessione fallita.");
    }
    
    function onConnectionLost(responseObject) {
        if (responseObject.errorCode !== 0) {
            console.error("CONNESSIONE PERSA:", responseObject.errorMessage);
            updateConnectionStatus(false, "Connessione persa.");
            elements.btnPompa.disabled = true;
            elements.btnRefresh.disabled = true;
        }
    }

    function onMessageArrived(message) {
        const topic = message.destinationName;
        const payload = message.payloadString;
        console.log(`MESSAGGIO RICEVUTO! Topic: ${topic}, Payload: ${payload}`);

        switch (topic) {
            case topics.statoPompa:
                console.log("Messaggio per lo stato pompa ricevuto. Chiamo updatePumpUI...");
                updatePumpUI(payload.toUpperCase());
                break;
            // ... altri case ...
            case topics.tempAria:
                elements.tempAria.textContent = `${parseFloat(payload).toFixed(1)} ¬∞C`;
                break;
            case topics.umiditaAria:
                elements.umiditaAria.textContent = `${parseFloat(payload).toFixed(1)} %`;
                break;
            case topics.umiditaTerreno:
                elements.umiditaTerreno.textContent = `${parseFloat(payload).toFixed(1)} %`;
                break;
        }
    }

    function updatePumpUI(state) {
        console.log("updatePumpUI chiamata con stato:", state);
        elements.btnPompa.disabled = false;
        console.log("Bottone Pompa Abilitato.");
        if (state === "ON") {
            elements.statoPompa.textContent = "Accesa";
            elements.btnPompa.textContent = "Spegni Pompa";
            elements.btnPompa.className = "button btn-on";
        } else {
            elements.statoPompa.textContent = "Spenta";
            elements.btnPompa.textContent = "Accendi Pompa";
            elements.btnPompa.className = "button btn-off";
        }
    }

    function togglePump() {
        console.log("togglePump ESEGUITA!");
        if (!client.isConnected()) {
            console.warn("Click ignorato, client non connesso.");
            return;
        }
        
        const currentState = elements.statoPompa.textContent;
        const command = (currentState === "Accesa") ? "OFF" : "ON";
        console.log("Invio comando:", command);
        
        const message = new Paho.MQTT.Message(command);
        message.destinationName = topics.cmdPompa;
        client.send(message);
        
        elements.btnPompa.disabled = true;
        elements.btnPompa.textContent = "Invio in corso...";
    }

    // ... altre funzioni ...
    function requestDataUpdate() {
        if (!client.isConnected()) return;
        const message = new Paho.MQTT.Message("1");
        message.destinationName = topics.cmdDataRequest;
        client.send(message);
        console.log("Richiesta di aggiornamento dati inviata!");
    }
    
    function updateConnectionStatus(connected, text) {
        if(connected){
            elements.connectionStatus.textContent = "Connesso al Broker MQTT";
            elements.connectionStatus.className = "status-connected";
        } else {
            elements.connectionStatus.textContent = text || "Disconnesso";
            elements.connectionStatus.className = "status-disconnected";
        }
    }
    
    console.log("Aggiungo event listeners ai bottoni...");
    elements.btnPompa.addEventListener('click', togglePump);
    elements.btnRefresh.addEventListener('click', requestDataUpdate);
    console.log("Script Terminato.");
</script>
</body>
</html>